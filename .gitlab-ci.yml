variables:
    GIT_DEPTH: 3

stages:
    - build-dev
    - test
    - build-push
    - build-prod
    - push
    - deploy

build-dev:
    script:
        - docker-compose up --build -d
    tags: [dev]
    only: [develop]

test:
    script:
        - docker build . -t ryazbeck/ygwifi:test -f Dockerfile.test
        - docker run
          --network=host
          --env-file /home/gitlab-runner/ygwifi-test.env
          ryazbeck/ygwifi:test
    tags: [dev]
    only: [develop]

build-push:
    script:
        - docker push ryazbeck/ygwifi:dev
    tags: [dev]
    only: [develop]

build-prod:
    script: docker-compose build
        --build-arg FLASK_ENV=production
        --build-arg LOG_LEVEL=WARNING
        --build-arg TESTING=False
        --build-arg TAG=latest
    tags: [dev]
    only: [master]

push:
    script: docker push ryazbeck/ygwifi:latest
    tags: [dev]
    only: [master]

deploy:
    script:
        - docker pull ryazbeck/ygwifi:latest
        - docker run ryazbeck/ygwifi:latest
    tags: [prod]
    only: [master]
